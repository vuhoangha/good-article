/*! jquery.atwho - v1.1.0 %>
* Copyright (c) 2015 chord.luo <chord.luo@gmail.com>;
* homepage: http://ichord.github.com/At.js
* Licensed MIT
*/
!function(root,factory){"function"==typeof define&&define.amd?define(["jquery"],function(jquery){return root.returnExportsGlobal=factory(jquery)}):"object"==typeof exports?module.exports=factory(require("jquery")):factory(jQuery)}(this,function(){var Api,App,Controller,DEFAULT_CALLBACKS,EditableController,KEY_CODE,Model,TextareaController,View,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};App=function(){function App(inputor){this.currentFlag=null,this.controllers={},this.aliasMaps={},this.$inputor=$(inputor),this.setupRootElement(),this.listen()}return App.prototype.createContainer=function(doc){var _ref;return null!=(_ref=this.$el)&&_ref.remove(),$(doc.body).append(this.$el=$("<div class='atwho-container'></div>"))},App.prototype.setupRootElement=function(iframe,asRoot){var error;if(null==asRoot&&(asRoot=!1),iframe)this.window=iframe.contentWindow,this.document=iframe.contentDocument||this.window.document,this.iframe=iframe;else{this.document=this.$inputor[0].ownerDocument,this.window=this.document.defaultView||this.document.parentWindow;try{this.iframe=this.window.frameElement}catch(_error){throw error=_error,this.iframe=null,new Error("iframe auto-discovery is failed.\nPlease use `setIframe` to set the target iframe manually.")}}return this.createContainer((this.iframeAsRoot=asRoot)?this.document:document)},App.prototype.controller=function(at){var c,current,currentFlag,_ref;if(this.aliasMaps[at])current=this.controllers[this.aliasMaps[at]];else{_ref=this.controllers;for(currentFlag in _ref)if(c=_ref[currentFlag],currentFlag===at){current=c;break}}return current?current:this.controllers[this.currentFlag]},App.prototype.setContextFor=function(at){return this.currentFlag=at,this},App.prototype.reg=function(flag,setting){var controller,_base;return controller=(_base=this.controllers)[flag]||(_base[flag]=this.$inputor.is("[contentEditable]")?new EditableController(this,flag):new TextareaController(this,flag)),setting.alias&&(this.aliasMaps[setting.alias]=flag),controller.init(setting),this},App.prototype.listen=function(){return this.$inputor.on("compositionstart",function(_this){return function(){var _ref;return null!=(_ref=_this.controller())&&_ref.view.hide(),_this.isComposing=!0}}(this)).on("compositionend",function(_this){return function(){return _this.isComposing=!1}}(this)).on("keyup.atwhoInner",function(_this){return function(e){return _this.onKeyup(e)}}(this)).on("keydown.atwhoInner",function(_this){return function(e){return _this.onKeydown(e)}}(this)).on("scroll.atwhoInner",function(_this){return function(e){var _ref;return null!=(_ref=_this.controller())?_ref.view.hide(e):void 0}}(this)).on("blur.atwhoInner",function(_this){return function(e){var c;return(c=_this.controller())?c.view.hide(e,c.getOpt("displayTimeout")):void 0}}(this)).on("click.atwhoInner",function(_this){return function(e){return _this.dispatch(e)}}(this))},App.prototype.shutdown=function(){var c,_,_ref;_ref=this.controllers;for(_ in _ref)c=_ref[_],c.destroy(),delete this.controllers[_];return this.$inputor.off(".atwhoInner"),this.$el.remove()},App.prototype.dispatch=function(e){return $.map(this.controllers,function(_this){return function(c){var delay;return(delay=c.getOpt("delay"))?(clearTimeout(_this.delayedCallback),_this.delayedCallback=setTimeout(function(){return c.lookUp(e)?_this.setContextFor(c.at):void 0},delay)):c.lookUp(e)?_this.setContextFor(c.at):void 0}}(this))},App.prototype.onKeyup=function(e){var _ref;switch(e.keyCode){case KEY_CODE.ESC:e.preventDefault(),null!=(_ref=this.controller())&&_ref.view.hide();break;case KEY_CODE.DOWN:case KEY_CODE.UP:case KEY_CODE.CTRL:$.noop();break;case KEY_CODE.P:case KEY_CODE.N:e.ctrlKey||this.dispatch(e);break;default:this.dispatch(e)}},App.prototype.onKeydown=function(e){var view,_ref;if(view=null!=(_ref=this.controller())?_ref.view:void 0,view&&view.visible())switch(e.keyCode){case KEY_CODE.ESC:e.preventDefault(),view.hide(e);break;case KEY_CODE.UP:e.preventDefault(),view.prev();break;case KEY_CODE.DOWN:e.preventDefault(),view.next();break;case KEY_CODE.P:if(!e.ctrlKey)return;e.preventDefault(),view.prev();break;case KEY_CODE.N:if(!e.ctrlKey)return;e.preventDefault(),view.next();break;case KEY_CODE.TAB:case KEY_CODE.ENTER:case KEY_CODE.SPACE:if(!view.visible())return;if(!this.controller().getOpt("spaceSelectsMatch")&&e.keyCode===KEY_CODE.SPACE)return;e.preventDefault(),view.choose(e);break;default:$.noop()}},App}(),Controller=function(){function Controller(app,at){this.app=app,this.at=at,this.$inputor=this.app.$inputor,this.id=this.$inputor[0].id||this.uid(),this.setting=null,this.query=null,this.pos=0,this.range=null,0===(this.$el=$("#atwho-ground-"+this.id,this.app.$el)).length&&this.app.$el.append(this.$el=$("<div id='atwho-ground-"+this.id+"'></div>")),this.model=new Model(this),this.view=new View(this)}return Controller.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date).getTime()},Controller.prototype.init=function(setting){return this.setting=$.extend({},this.setting||$.fn.atwho["default"],setting),this.view.init(),this.model.reload(this.setting.data)},Controller.prototype.destroy=function(){return this.trigger("beforeDestroy"),this.model.destroy(),this.view.destroy(),this.$el.remove()},Controller.prototype.callDefault=function(){var args,error,funcName;funcName=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];try{return DEFAULT_CALLBACKS[funcName].apply(this,args)}catch(_error){return error=_error,$.error(""+error+" Or maybe At.js doesn't have function "+funcName)}},Controller.prototype.trigger=function(name,data){var alias,eventName;return null==data&&(data=[]),data.push(this),alias=this.getOpt("alias"),eventName=alias?""+name+"-"+alias+".atwho":""+name+".atwho",this.$inputor.trigger(eventName,data)},Controller.prototype.callbacks=function(funcName){return this.getOpt("callbacks")[funcName]||DEFAULT_CALLBACKS[funcName]},Controller.prototype.getOpt=function(at){var e;try{return this.setting[at]}catch(_error){return e=_error,null}},Controller.prototype.insertContentFor=function($li){var data,tpl;return tpl=this.getOpt("insertTpl"),data=$.extend({},$li.data("item-data"),{"atwho-at":this.at}),this.callbacks("tplEval").call(this,tpl,data)},Controller.prototype.renderView=function(data){var searchKey;return searchKey=this.getOpt("searchKey"),data=this.callbacks("sorter").call(this,this.query.text,data.slice(0,1001),searchKey),this.view.render(data.slice(0,this.getOpt("limit")))},Controller.arrayToDefaultHash=function(data){var item,_i,_len,_results;if(!$.isArray(data))return data;for(_results=[],_i=0,_len=data.length;_len>_i;_i++)item=data[_i],_results.push($.isPlainObject(item)?item:{name:item});return _results},Controller.prototype.lookUp=function(e){var query,_callback;if(query=this.catchQuery(e))return _callback=function(data){return data&&data.length>0?this.renderView(this.constructor.arrayToDefaultHash(data)):this.view.hide()},this.model.query(query.text,$.proxy(_callback,this)),query},Controller}(),TextareaController=function(_super){function TextareaController(){return TextareaController.__super__.constructor.apply(this,arguments)}return __extends(TextareaController,_super),TextareaController.prototype.catchQuery=function(){var caretPos,content,end,query,start,subtext;return content=this.$inputor.val(),caretPos=this.$inputor.caret("pos",{iframe:this.app.iframe}),subtext=content.slice(0,caretPos),query=this.callbacks("matcher").call(this,this.at,subtext,this.getOpt("startWithSpace")),"string"==typeof query&&query.length<=this.getOpt("maxLen",20)?(start=caretPos-query.length,end=start+query.length,this.pos=start,query={text:query,headPos:start,endPos:end},this.trigger("matched",[this.at,query.text])):(query=null,this.view.hide()),this.query=query},TextareaController.prototype.rect=function(){var c,iframeOffset,scaleBottom;if(c=this.$inputor.caret("offset",this.pos-1,{iframe:this.app.iframe}))return this.app.iframe&&!this.app.iframeAsRoot&&(iframeOffset=$(this.app.iframe).offset(),c.left+=iframeOffset.left,c.top+=iframeOffset.top),scaleBottom=this.app.document.selection?0:2,{left:c.left,top:c.top,bottom:c.top+c.height+scaleBottom}},TextareaController.prototype.insert=function(content){var $inputor,source,startStr,suffix,text;return $inputor=this.$inputor,source=$inputor.val(),startStr=source.slice(0,Math.max(this.query.headPos-this.at.length,0)),suffix=""===(suffix=this.getOpt("suffix"))?suffix:suffix||" ",content+=suffix,text=""+startStr+content+source.slice(this.query.endPos||0),$inputor.val(text),$inputor.caret("pos",startStr.length+content.length,{iframe:this.app.iframe}),$inputor.is(":focus")||$inputor.focus(),$inputor.change()},TextareaController}(Controller),EditableController=function(_super){function EditableController(){return EditableController.__super__.constructor.apply(this,arguments)}return __extends(EditableController,_super),EditableController.prototype._getRange=function(){var sel;return sel=this.app.window.getSelection(),sel.rangeCount>0?sel.getRangeAt(0):void 0},EditableController.prototype._setRange=function(position,node,range){return null==range&&(range=this._getRange()),range?(node=$(node)[0],"after"===position?(range.setEndAfter(node),range.setStartAfter(node)):(range.setEndBefore(node),range.setStartBefore(node)),range.collapse(!1),this._clearRange(range)):void 0},EditableController.prototype._clearRange=function(range){var sel;return null==range&&(range=this._getRange()),sel=this.app.window.getSelection(),sel.removeAllRanges(),sel.addRange(range)},EditableController.prototype._movingEvent=function(e){var _ref;return"click"===e.type||(_ref=e.which)===KEY_CODE.RIGHT||_ref===KEY_CODE.LEFT||_ref===KEY_CODE.UP||_ref===KEY_CODE.DOWN},EditableController.prototype._unwrap=function(node){var next;return node=$(node).unwrap().get(0),(next=node.nextSibling)&&next.nodeValue&&(node.nodeValue+=next.nodeValue,$(next).remove()),node},EditableController.prototype.catchQuery=function(e){var $inserted,$query,index,inserted,lastNode,matched,offset,query,range,_range;if(!this.app.isComposing&&(range=this._getRange())){if(e.which===KEY_CODE.ENTER)return($query=$(range.startContainer).closest(".atwho-query")).contents().unwrap(),$query.is(":empty")&&$query.remove(),($query=$(".atwho-query",this.app.document)).text($query.text()).contents().last().unwrap(),void this._clearRange();if(/firefox/i.test(navigator.userAgent)){if($(range.startContainer).is(this.$inputor))return void this._clearRange();e.which===KEY_CODE.BACKSPACE&&range.startContainer.nodeType===document.ELEMENT_NODE&&(offset=range.startOffset-1)>=0?(_range=range.cloneRange(),_range.setStart(range.startContainer,offset),$(_range.cloneContents()).contents().last().is(".atwho-inserted")&&(inserted=$(range.startContainer).contents().get(offset),this._setRange("after",$(inserted).contents().last()))):e.which===KEY_CODE.LEFT&&range.startContainer.nodeType===document.TEXT_NODE&&($inserted=$(range.startContainer.previousSibling),$inserted.is(".atwho-inserted")&&0===range.startOffset&&this._setRange("after",$inserted.contents().last()))}return $(range.startContainer).closest(".atwho-inserted").addClass("atwho-query").siblings().removeClass("atwho-query"),($query=$(".atwho-query",this.app.document)).length>0&&$query.is(":empty")&&0===$query.text().length&&$query.remove(),this._movingEvent(e)||$query.removeClass("atwho-inserted"),_range=range.cloneRange(),_range.setStart(range.startContainer,0),matched=this.callbacks("matcher").call(this,this.at,_range.toString(),this.getOpt("startWithSpace")),0===$query.length&&"string"==typeof matched&&(index=range.startOffset-this.at.length-matched.length)>=0&&(range.setStart(range.startContainer,index),$query=$("<span/>",this.app.document).attr(this.getOpt("editableAtwhoQueryAttrs")).addClass("atwho-query"),range.surroundContents($query.get(0)),lastNode=$query.contents().last().get(0),/firefox/i.test(navigator.userAgent)?(range.setStart(lastNode,lastNode.length),range.setEnd(lastNode,lastNode.length),this._clearRange(range)):this._setRange("after",lastNode,range)),"string"==typeof matched&&matched.length<=this.getOpt("maxLen",20)?(query={text:matched,el:$query},this.trigger("matched",[this.at,query.text]),this.query=query):(this.view.hide(),this.query={el:$query},$query.text().indexOf(this.at)>=0&&(this._movingEvent(e)&&$query.hasClass("atwho-inserted")?$query.removeClass("atwho-query"):!1!==this.callbacks("afterMatchFailed").call(this,this.at,$query)&&this._setRange("after",this._unwrap($query.text($query.text()).contents().first()))),null)}},EditableController.prototype.rect=function(){var $iframe,iframeOffset,rect;return rect=this.query.el.offset(),this.app.iframe&&!this.app.iframeAsRoot&&(iframeOffset=($iframe=$(this.app.iframe)).offset(),rect.left+=iframeOffset.left-this.$inputor.scrollLeft(),rect.top+=iframeOffset.top-this.$inputor.scrollTop()),rect.bottom=rect.top+this.query.el.height(),rect},EditableController.prototype.insert=function(content){var range,suffix,suffixNode;return suffix=(suffix=this.getOpt("suffix"))?suffix:suffix||"\xa0",this.query.el.removeClass("atwho-query").addClass("atwho-inserted").html(content),(range=this._getRange())&&(range.setEndAfter(this.query.el[0]),range.collapse(!1),range.insertNode(suffixNode=this.app.document.createTextNode(suffix)),this._setRange("after",suffixNode,range)),this.$inputor.is(":focus")||this.$inputor.focus(),this.$inputor.change()},EditableController}(Controller),Model=function(){function Model(context){this.context=context,this.at=this.context.at,this.storage=this.context.$inputor}return Model.prototype.destroy=function(){return this.storage.data(this.at,null)},Model.prototype.saved=function(){return this.fetch()>0},Model.prototype.query=function(query,callback){var data,searchKey,_remoteFilter;return data=this.fetch(),searchKey=this.context.getOpt("searchKey"),data=this.context.callbacks("filter").call(this.context,query,data,searchKey)||[],_remoteFilter=this.context.callbacks("remoteFilter"),data.length>0||!_remoteFilter&&0===data.length?callback(data):_remoteFilter.call(this.context,query,callback)},Model.prototype.fetch=function(){return this.storage.data(this.at)||[]},Model.prototype.save=function(data){return this.storage.data(this.at,this.context.callbacks("beforeSave").call(this.context,data||[]))},Model.prototype.load=function(data){return!this.saved()&&data?this._load(data):void 0},Model.prototype.reload=function(data){return this._load(data)},Model.prototype._load=function(data){return"string"==typeof data?$.ajax(data,{dataType:"json"}).done(function(_this){return function(data){return _this.save(data)}}(this)):this.save(data)},Model}(),View=function(){function View(context){this.context=context,this.$el=$("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>"),this.timeoutID=null,this.context.$el.append(this.$el),this.bindEvent()}return View.prototype.init=function(){var id;return id=this.context.getOpt("alias")||this.context.at.charCodeAt(0),this.$el.attr({id:"at-view-"+id})},View.prototype.destroy=function(){return this.$el.remove()},View.prototype.bindEvent=function(){var $menu;return $menu=this.$el.find("ul"),$menu.on("mouseenter.atwho-view","li",function(e){return $menu.find(".cur").removeClass("cur"),$(e.currentTarget).addClass("cur")}).on("click.atwho-view","li",function(_this){return function(e){return $menu.find(".cur").removeClass("cur"),$(e.currentTarget).addClass("cur"),_this.choose(e),e.preventDefault()}}(this))},View.prototype.visible=function(){return this.$el.is(":visible")},View.prototype.choose=function(e){var $li,content;return($li=this.$el.find(".cur")).length&&(content=this.context.insertContentFor($li),this.context.insert(this.context.callbacks("beforeInsert").call(this.context,content,$li),$li),this.context.trigger("inserted",[$li,e]),this.hide(e)),this.context.getOpt("hideWithoutSuffix")?this.stopShowing=!0:void 0},View.prototype.reposition=function(rect){var offset,overflowOffset,_ref,_window;return _window=this.context.app.iframeAsRoot?this.context.app.window:window,rect.bottom+this.$el.height()-$(_window).scrollTop()>$(_window).height()&&(rect.bottom=rect.top-this.$el.height()),rect.left>(overflowOffset=$(_window).width()-this.$el.width()-5)&&(rect.left=overflowOffset),offset={left:rect.left,top:rect.bottom},null!=(_ref=this.context.callbacks("beforeReposition"))&&_ref.call(this.context,offset),this.$el.offset(offset),this.context.trigger("reposition",[offset])},View.prototype.next=function(){var cur,next;return cur=this.$el.find(".cur").removeClass("cur"),next=cur.next(),next.length||(next=this.$el.find("li:first")),next.addClass("cur"),this.$el.animate({scrollTop:Math.max(0,cur.innerHeight()*(next.index()+2)-this.$el.height())},150)},View.prototype.prev=function(){var cur,prev;return cur=this.$el.find(".cur").removeClass("cur"),prev=cur.prev(),prev.length||(prev=this.$el.find("li:last")),prev.addClass("cur"),this.$el.animate({scrollTop:Math.max(0,cur.innerHeight()*(prev.index()+2)-this.$el.height())},150)},View.prototype.show=function(){var rect;return this.stopShowing?void(this.stopShowing=!1):(this.visible()||(this.$el.show(),this.$el.scrollTop(0),this.context.trigger("shown")),(rect=this.context.rect())?this.reposition(rect):void 0)},View.prototype.hide=function(e,time){var callback;if(this.visible())return isNaN(time)?(this.$el.hide(),this.context.trigger("hidden",[e])):(callback=function(_this){return function(){return _this.hide()}}(this),clearTimeout(this.timeoutID),this.timeoutID=setTimeout(callback,time))},View.prototype.render=function(list){var $li,$ul,item,li,tpl,_i,_len;if(!($.isArray(list)&&list.length>0))return void this.hide();for(this.$el.find("ul").empty(),$ul=this.$el.find("ul"),tpl=this.context.getOpt("displayTpl"),_i=0,_len=list.length;_len>_i;_i++)item=list[_i],item=$.extend({},item,{"atwho-at":this.context.at}),li=this.context.callbacks("tplEval").call(this.context,tpl,item),$li=$(this.context.callbacks("highlighter").call(this.context,li,this.context.query.text)),$li.data("item-data",item),$ul.append($li);return this.show(),this.context.getOpt("highlightFirst")?$ul.find("li:first").addClass("cur"):void 0},View}(),KEY_CODE={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,P:80,N:78,LEFT:37,UP:38,RIGHT:39,DOWN:40,BACKSPACE:8,SPACE:32},DEFAULT_CALLBACKS={beforeSave:function(data){return Controller.arrayToDefaultHash(data)},matcher:function(flag,subtext,should_startWithSpace){var match,regexp,_a,_y;return flag=flag.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),should_startWithSpace&&(flag="(?:^|\\s)"+flag),_a=decodeURI("%C3%80"),_y=decodeURI("%C3%BF"),regexp=new RegExp(""+flag+"([A-Za-z"+_a+"-"+_y+"0-9_.+-]*)$|"+flag+"([^\\x00-\\xff]*)$","gi"),match=regexp.exec(subtext),match?match[2]||match[1]:null},filter:function(query,data,searchKey){var item,_i,_len,_results;for(_results=[],_i=0,_len=data.length;_len>_i;_i++)item=data[_i],~new String(item[searchKey]).toLowerCase().indexOf(query.toLowerCase())&&_results.push(item);return _results},remoteFilter:null,sorter:function(query,items,searchKey){var item,_i,_len,_results;if(!query)return items;for(_results=[],_i=0,_len=items.length;_len>_i;_i++)item=items[_i],item.atwho_order=new String(item[searchKey]).toLowerCase().indexOf(query.toLowerCase()),item.atwho_order>-1&&_results.push(item);return _results.sort(function(a,b){return a.atwho_order-b.atwho_order})},tplEval:function(tpl,map){var error,template;template=tpl;try{return"string"!=typeof tpl&&(template=tpl(map)),template.replace(/\$\{([^\}]*)\}/g,function(tag,key){return map[key]})}catch(_error){return error=_error,""}},highlighter:function(li,query){var regexp;return query?(regexp=new RegExp(">\\s*(\\w*?)("+query.replace("+","\\+")+")(\\w*)\\s*<","ig"),li.replace(regexp,function(str,$1,$2,$3){return"> "+$1+"<strong>"+$2+"</strong>"+$3+" <"})):li},beforeInsert:function(value){return value},beforeReposition:function(offset){return offset},afterMatchFailed:function(){}},Api={load:function(at,data){var c;return(c=this.controller(at))?c.model.load(data):void 0},isSelecting:function(){var _ref;return null!=(_ref=this.controller())?_ref.view.visible():void 0},setIframe:function(iframe,asRoot){return this.setupRootElement(iframe,asRoot),null},run:function(){return this.dispatch()},destroy:function(){return this.shutdown(),this.$inputor.data("atwho",null)}},$.fn.atwho=function(method){var result,_args;return _args=arguments,result=null,this.filter('textarea, input, [contenteditable=""], [contenteditable=true]').each(function(){var $this,app;return(app=($this=$(this)).data("atwho"))||$this.data("atwho",app=new App(this)),"object"!=typeof method&&method?Api[method]&&app?result=Api[method].apply(app,Array.prototype.slice.call(_args,1)):$.error("Method "+method+" does not exist on jQuery.caret"):app.reg(method.at,method)}),result||this},$.fn.atwho["default"]={at:void 0,alias:void 0,data:null,displayTpl:"<li>${name}</li>",insertTpl:"${atwho-at}${name}",callbacks:DEFAULT_CALLBACKS,searchKey:"name",suffix:void 0,hideWithoutSuffix:!1,startWithSpace:!0,highlightFirst:!0,limit:5,maxLen:20,displayTimeout:300,delay:null,spaceSelectsMatch:!1,editableAtwhoQueryAttrs:{}}});